services:
  # 1. Redis - Core dependency for all services
  redis:
    image: redis:7-alpine
    container_name: demestihas-redis
    restart: unless-stopped
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - demestihas-network
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s

  # 2. MCP Smart Memory - Memory management service
  mcp-memory:
    build:
      context: ./mcp-smart-memory
      dockerfile: ../dockerfiles/mcp-memory.Dockerfile
    container_name: demestihas-mcp-memory
    restart: unless-stopped
    ports:
      - "7777:7777"
    environment:
      - NODE_ENV=production
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials/google-credentials.json
      - PORT=7777
      - TZ=America/New_York
    volumes:
      - ./mcp-smart-memory/data:/app/data
      - ./mcp-smart-memory/credentials:/app/credentials:ro
      - ./logs/mcp-memory:/app/logs
    networks:
      - demestihas-network
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:7777/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # 3. Huata Calendar - Calendar management service
  huata:
    build: ./huata
    container_name: demestihas-huata
    restart: unless-stopped
    ports:
      - "8003:8003"
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - HUATA_PORT=8003
      - HUATA_HOST=0.0.0.0
      - ENV=production
      - TZ=America/New_York
    volumes:
      - ./huata/credentials:/app/credentials:ro
      - ./logs/huata:/app/logs
    networks:
      - demestihas-network
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8003/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # 4. Lyco v2 - Task processing service
  lyco-v2:
    build:
      context: ./agents/lyco/lyco-v2
      dockerfile: Dockerfile
    container_name: demestihas-lyco-v2
    restart: unless-stopped
    ports:
      - "8000:8000"
    env_file:
      - ./agents/lyco/lyco-v2/.env
    environment:
      - PYTHONUNBUFFERED=1
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_URL=redis://redis:6379
      - TZ=America/New_York
    volumes:
      - ./agents/lyco/lyco-v2:/app
      - ./agents/lyco/lyco-v2/credentials:/app/credentials:ro
      - ./logs/lyco-v2:/app/logs
    networks:
      - demestihas-network
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # 5. EA-AI Bridge - HTTP interface to EA-AI tools
  ea-ai-bridge:
    build:
      context: ./ea-ai-container
      dockerfile: ../dockerfiles/ea-ai-bridge.Dockerfile
    container_name: demestihas-ea-ai-bridge
    restart: unless-stopped
    ports:
      - "8081:8080"
    environment:
      - NODE_ENV=production
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - LYCO_URL=http://lyco-v2:8000
      - HUATA_URL=http://huata:8003
      - MCP_MEMORY_URL=http://mcp-memory:7777
      - PORT=8080
      - TZ=America/New_York
    volumes:
      - ./ea-ai-container/cache:/app/cache
      - ./ea-ai-container/state:/app/state
      - ./logs/ea-ai-bridge:/app/logs
    networks:
      - demestihas-network
    depends_on:
      redis:
        condition: service_healthy
      lyco-v2:
        condition: service_healthy
      huata:
        condition: service_healthy
      mcp-memory:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # 6. IRIS - Social Media Agent
  iris:
    container_name: demestihas-iris
    build: ./agents/iris
    ports:
      - "8005:8005"
    networks:
      - demestihas-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8005/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # 6.5 Executive Briefing Service
  executive-briefing:
    build: ./services/executive-briefing
    container_name: demestihas-executive-briefing
    restart: unless-stopped
    ports:
      - "8060:8060"
    environment:
      - PORT=8060
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_REFRESH_TOKEN=${GOOGLE_REFRESH_TOKEN}
      - TASK_API_KEY=${TASK_API_KEY}
      - ANTHROPIC_MODEL=${ANTHROPIC_MODEL:-claude-3-haiku-20240307}
      - TZ=America/New_York
    networks:
      - demestihas-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8060/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # 7. Status Dashboard - Unified monitoring interface
  status-dashboard:
    build:
      context: ./services/status-dashboard
      dockerfile: ../../dockerfiles/status-dashboard.Dockerfile
    container_name: demestihas-status-dashboard
    restart: unless-stopped
    ports:
      - "9999:9999"
    environment:
      - NODE_ENV=production
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - PORT=9999
      - TZ=America/New_York
      - SERVICES_CONFIG=[{"name":"Redis","url":"http://redis:6379","port":6379,"type":"redis"},{"name":"MCP Memory","url":"http://mcp-memory:7777/health","port":7777},{"name":"Huata Calendar","url":"http://huata:8003/health","port":8003},{"name":"Lyco v2","url":"http://lyco-v2:8000/api/health","port":8000},{"name":"EA-AI Bridge","url":"http://ea-ai-bridge:8080/health","port":8080}]
    volumes:
      - ./logs/status-dashboard:/app/logs
    networks:
      - demestihas-network
    depends_on:
      - redis
      - mcp-memory
      - huata
      - lyco-v2

  # 8. Terminal Capture - Brain dump interface
  terminal-capture:
    build:
      context: ./agents/lyco
      dockerfile: ../../dockerfiles/terminal-capture.Dockerfile
    container_name: demestihas-terminal-capture
    restart: unless-stopped
    environment:
      - LYCO_API_URL=http://lyco-v2:8000
      - LYCO_WS_URL=ws://lyco-v2:8000/ws
      - TZ=America/New_York
    volumes:
      - ./logs/brain-dumps:/app/logs/brain-dumps
      - ./agents/lyco/terminal-capture.py:/app/terminal-capture.py:ro
    networks:
      - demestihas-network
    stdin_open: true
    tty: true
    depends_on:
      lyco-v2:
        condition: service_healthy
    profiles:
      - terminal

  # 9. Email Gateway - Email task capture service
  email-gateway:
    build:
      context: ./agents/pluma
      dockerfile: ../../dockerfiles/email-gateway.Dockerfile
    container_name: demestihas-email-gateway
    restart: unless-stopped
    environment:
      - GMAIL_CHECK_INTERVAL=${GMAIL_CHECK_INTERVAL:-60}
      - GMAIL_TASKS_LABEL=${GMAIL_TASKS_LABEL:-tasks@demestihas.ai}
      - ADMIN_EMAIL=${ADMIN_EMAIL:-menelaos4@gmail.com}
      - LYCO_API_URL=http://lyco-v2:8000
      - TZ=America/New_York
    volumes:
      - ./logs:/app/logs
      - ./agents/pluma/email-gateway.py:/app/email-gateway.py:ro
      - ./agents/pluma/credentials:/app/credentials:ro
    networks:
      - demestihas-network
    depends_on:
      lyco-v2:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "python", "-c", "import sys; sys.exit(0)" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # 10. Notion Bridge - Bidirectional sync service
  notion-bridge:
    build:
      context: ./agents/bridge
      dockerfile: ../../dockerfiles/notion-bridge.Dockerfile
    container_name: demestihas-notion-bridge
    restart: unless-stopped
    environment:
      - SYNC_INTERVAL_SECONDS=${SYNC_INTERVAL:-300}
      - NOTION_API_KEY=${NOTION_API_KEY}
      - NOTION_DATABASE_ID=${NOTION_DATABASE_ID:-245413ec-f376-8021-8ddc-000b4ab96ae2}
      - LYCO_API_URL=http://lyco-v2:8000
      - LYCO_DB_PATH=/app/data/lyco.db
      - REDIS_URL=redis://redis:6379
      - TZ=America/New_York
    volumes:
      - ./logs/sync-audit:/app/logs/sync-audit
      - ./agents/bridge/notion-lyco-sync.py:/app/notion-lyco-sync.py:ro
      - ./agents/bridge/field-mappings.json:/app/field-mappings.json:ro
      - ./agents/lyco/lyco.db:/app/data/lyco.db
    networks:
      - demestihas-network
    depends_on:
      lyco-v2:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "python", "-c", "import sys; sys.exit(0)" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

volumes:
  redis_data:
    driver: local

networks:
  demestihas-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
