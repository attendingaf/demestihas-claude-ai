#!/usr/bin/env python3
"""
Lyco.ai Bot v5 - Production Ready with Enhanced AI & Family Coordination
"""

import os
import asyncio
import logging
import json
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, CallbackQueryHandler, filters, ContextTypes
from datetime import datetime, timedelta
import aiohttp
from ai_task_parser import EnhancedTaskParser, FamilyMember

# Enhanced logging
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(funcName)s:%(lineno)d - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# Configuration
BOT_TOKEN = os.environ.get('TELEGRAM_BOT_TOKEN', '')
ANTHROPIC_API_KEY = os.environ.get('ANTHROPIC_API_KEY', '')
NOTION_TOKEN = os.environ.get('NOTION_TOKEN', '')
NOTION_DATABASE_ID = os.environ.get('NOTION_DATABASE_ID', '')
NOTION_VERSION = '2022-06-28'

# Initialize enhanced parser
task_parser = EnhancedTaskParser(ANTHROPIC_API_KEY) if ANTHROPIC_API_KEY else None

# User session storage (in production, use Redis)
user_sessions = {}

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Enhanced start with family context"""
    user = update.effective_user
    
    # Initialize user session
    user_sessions[user.id] = {
        'name': user.first_name,
        'tasks_today': 0,
        'last_energy_check': datetime.now(),
        'family_mode': False
    }
    
    keyboard = [
        [InlineKeyboardButton("ğŸ“ Quick Task", callback_data='quick_task')],
        [InlineKeyboardButton("ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Family Mode", callback_data='family_mode')],
        [InlineKeyboardButton("âš¡ Energy Check", callback_data='energy_check')],
        [InlineKeyboardButton("ğŸ“Š Today's Tasks", callback_data='today_tasks')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    welcome_message = f'''ğŸ§  **Welcome to Lyco, {user.first_name}!**
    
I'm your ADHD-optimized task assistant with family coordination.

**ğŸ¯ Core Features:**
â€¢ Natural language task capture
â€¢ Auto-categorization (Eisenhower Matrix)
â€¢ Family member delegation
â€¢ Energy-based scheduling
â€¢ ADHD-friendly breakdowns

**ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Family Members:**
â€¢ **Cindy** - Wife, physician
â€¢ **Viola** - Au pair (childcare/transport)
â€¢ **Persy** (11) - Oldest
â€¢ **Stelios** (8) - Middle
â€¢ **Franci** (5) - Youngest

**ğŸ’¬ Just send me any task or use the buttons below!**

Examples:
â€¢ "Buy groceries for dinner"
â€¢ "Ask Viola to pick up kids at 3pm"
â€¢ "Review budget report tomorrow"
â€¢ "Emergency: Call pediatrician now"'''
    
    await update.message.reply_text(
        welcome_message,
        parse_mode='Markdown',
        reply_markup=reply_markup
    )

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Enhanced message handler with AI parsing"""
    task_text = update.message.text
    user = update.effective_user
    user_id = user.id
    
    # Update session
    if user_id not in user_sessions:
        user_sessions[user_id] = {'name': user.first_name, 'tasks_today': 0}
    
    user_sessions[user_id]['tasks_today'] += 1
    
    # Send typing indicator
    await context.bot.send_chat_action(chat_id=update.effective_chat.id, action='typing')
    
    # Send immediate acknowledgment
    thinking = await update.message.reply_text(
        f'ğŸ§  Processing: "{task_text[:50]}{"..." if len(task_text) > 50 else ""}"'
    )
    
    # Parse with enhanced AI
    if task_parser:
        analysis = await task_parser.parse_with_ai(task_text, user_sessions.get(user_id))
    else:
        # Fallback parsing
        analysis = {
            'parsed_task': task_text,
            'eisenhower': 'ğŸ§  Brain Dump',
            'energy': 'Medium',
            'time_estimate': 'ğŸ“ Short (15-30m)',
            'context': ['Quick Win'],
            'assigned_to': None,
            'due_date': None,
            'adhd_notes': '',
            'record_type': 'Task'
        }
    
    # Save to Notion with enhanced properties
    saved, save_message = await save_to_notion_enhanced(analysis, user.first_name)
    
    # Format enhanced response
    response = format_task_response(analysis, saved, save_message)
    
    # Add quick actions keyboard
    keyboard = []
    
    # If task is complex, offer breakdown
    if analysis['energy'] == 'High':
        keyboard.append([InlineKeyboardButton("ğŸ”¨ Break it down", callback_data=f"breakdown_{thinking.message_id}")])
    
    # If delegated, offer to notify
    if analysis.get('assigned_to') and analysis['assigned_to'] != 'mene':
        keyboard.append([InlineKeyboardButton(f"ğŸ“± Notify {analysis['assigned_to'].title()}", callback_data=f"notify_{analysis['assigned_to']}")])
    
    keyboard.append([InlineKeyboardButton("âœ… Mark Complete", callback_data=f"complete_{thinking.message_id}")])
    
    reply_markup = InlineKeyboardMarkup(keyboard) if keyboard else None
    
    # Update message with full response
    await thinking.edit_text(
        response, 
        parse_mode='Markdown',
        reply_markup=reply_markup,
        disable_web_page_preview=True
    )
    
    # Log for monitoring
    logger.info(f"Task from {user.first_name} ({user_id}): {task_text[:50]} -> {analysis['eisenhower']}")
    
    # ADHD support: Remind about breaks after 5 tasks
    if user_sessions[user_id]['tasks_today'] % 5 == 0:
        await asyncio.sleep(2)
        await update.message.reply_text(
            "ğŸ§  **ADHD Break Reminder**\n\n"
            "You've captured 5 tasks! Time for a 5-minute break.\n"
            "Stand up, stretch, or grab some water. ğŸ’§",
            parse_mode='Markdown'
        )

def format_task_response(analysis: dict, saved: bool, save_message: str) -> str:
    """Format the task/shopping analysis response"""
    record_type = analysis.get('record_type', 'Task')
    
    if record_type == 'Shopping':
        # Shopping item response
        response = f'''ğŸ›’ **Shopping Item Captured!**

ğŸ“ **Item:** {analysis['parsed_task']}
ğŸª **Store:** {analysis.get('store', 'Any')}'''
        
        if analysis.get('grocery_category'):
            response += f"\nğŸ·ï¸ **Category:** {analysis['grocery_category']}"
        if analysis.get('quantity'):
            response += f"\nğŸ“¦ **Quantity:** {analysis['quantity']}"
    else:
        # Task response
        response = f'''âœ… **Task Captured!**

ğŸ“ **Task:** {analysis['parsed_task']}
ğŸ“Š **Priority:** {analysis['eisenhower']}'''
    
    # Add assignment if delegated
    if analysis.get('assigned_to'):
        family_names = {
            'cindy': 'Cindy (Wife)',
            'viola': 'Viola (Au Pair)',
            'persy': 'Persy (11yo)',
            'stelios': 'Stelios (8yo)', 
            'franci': 'Franci (5yo)',
            'mene': 'You'
        }
        assignee = family_names.get(analysis['assigned_to'], analysis['assigned_to'].title())
        response += f'\nğŸ‘¤ **Assigned:** {assignee}'
    
    response += f'''
âš¡ **Energy:** {analysis['energy']}
â±ï¸ **Time:** {analysis['time_estimate']}
ğŸ·ï¸ **Context:** {', '.join(analysis['context'])}'''
    
    if analysis.get('due_date'):
        # Format date nicely
        try:
            due = datetime.strptime(analysis['due_date'], '%Y-%m-%d')
            today = datetime.now().date()
            due_date = due.date()
            
            if due_date == today:
                due_str = "Today"
            elif due_date == today + timedelta(days=1):
                due_str = "Tomorrow"
            else:
                due_str = due.strftime('%B %d')
            
            response += f"\nğŸ“… **Due:** {due_str}"
        except:
            response += f"\nğŸ“… **Due:** {analysis['due_date']}"
    
    # Add ADHD tips if present
    if analysis.get('adhd_notes'):
        response += f"\n\nğŸ’¡ **ADHD Tip:** {analysis['adhd_notes']}"
    
    # Save status
    response += "\n\n"
    if saved:
        response += "âœ¨ **Saved to Notion!**\n"
        response += f"ğŸ“± [Open in Notion](https://www.notion.so/{NOTION_DATABASE_ID})"
    else:
        response += f"âš ï¸ **Save failed:** {save_message}"
    
    return response

async def save_to_notion_enhanced(task_data: dict, user_name: str) -> tuple[bool, str]:
    """Enhanced Notion save with family fields and shopping support"""
    headers = {
        'Authorization': f'Bearer {NOTION_TOKEN}',
        'Content-Type': 'application/json',
        'Notion-Version': NOTION_VERSION
    }
    
    # Build properties with all fields
    properties = {
        'Name': {
            'title': [{
                'text': {'content': task_data['parsed_task']}
            }]
        },
        'Source': {
            'select': {'name': 'Telegram'}
        },
        'Notes': {
            'rich_text': [{
                'text': {
                    'content': f"Added by {user_name} via Lyco v5\n"
                              f"Time: {datetime.now().strftime('%Y-%m-%d %H:%M')}\n"
                              f"{task_data.get('adhd_notes', '')}"
                }
            }]
        }
    }
    
    # Add RecordType
    record_type = task_data.get('record_type', 'Task')
    properties['RecordType'] = {
        'select': {'name': record_type}
    }
    
    # Handle Shopping-specific fields
    if record_type == 'Shopping':
        # Shopping items have different fields
        if task_data.get('store'):
            properties['Store'] = {
                'select': {'name': task_data['store']}
            }
        if task_data.get('grocery_category'):
            properties['GroceryCategory'] = {
                'select': {'name': task_data['grocery_category']}
            }
        if task_data.get('quantity'):
            properties['Quantity'] = {
                'rich_text': [{'text': {'content': task_data['quantity']}}]
            }
        # Shopping items don't use Eisenhower
    else:
        # Task-specific fields
        if task_data.get('eisenhower'):
            properties['Eisenhower'] = {
                'select': {'name': task_data['eisenhower']}
            }
        properties['Energy Level Required'] = {
            'select': {'name': task_data['energy']}
        }
        properties['Time Estimate'] = {
            'select': {'name': task_data['time_estimate']}
        }
    
    # Add context tags
    if task_data.get('context'):
        properties['Context/Tags'] = {
            'multi_select': [{'name': tag} for tag in task_data['context']]
        }
    
    # Add due date
    if task_data.get('due_date'):
        properties['Due Date'] = {
            'date': {'start': task_data['due_date']}
        }
    
    # Add family member assignment (as text for now, until Notion user IDs are mapped)
    if task_data.get('assigned_to'):
        # Store in Notes field until we have proper People field mapping
        existing_notes = properties['Notes']['rich_text'][0]['text']['content']
        properties['Notes']['rich_text'][0]['text']['content'] = (
            f"Assigned to: {task_data['assigned_to'].title()}\n{existing_notes}"
        )
    
    # Prepare request
    notion_data = {
        'parent': {'database_id': NOTION_DATABASE_ID},
        'properties': properties
    }
    
    logger.info(f"Saving to Notion: {task_data['parsed_task'][:50]}")
    
    try:
        async with aiohttp.ClientSession() as session:
            async with session.post(
                'https://api.notion.com/v1/pages',
                headers=headers,
                json=notion_data,
                timeout=10
            ) as response:
                if response.status == 200:
                    result = await response.json()
                    return True, f"ID: {result['id'][:8]}"
                else:
                    error_text = await response.text()
                    logger.error(f"Notion error: {error_text}")
                    return False, f"API error {response.status}"
                    
    except asyncio.TimeoutError:
        return False, "Timeout"
    except Exception as e:
        logger.error(f"Notion save error: {e}")
        return False, str(e)[:50]

async def button_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle inline button callbacks"""
    query = update.callback_query
    await query.answer()
    
    data = query.data
    
    if data == 'family_mode':
        await query.edit_message_text(
            "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ **Family Mode Active!**\n\n"
            "I'll now suggest family member assignments for tasks.\n\n"
            "Try: 'Ask Viola to take kids to soccer' or 'Wife needs to call pediatrician'",
            parse_mode='Markdown'
        )
        
    elif data == 'energy_check':
        # Simple energy check
        keyboard = [
            [InlineKeyboardButton("ğŸ”‹ High Energy", callback_data='energy_high')],
            [InlineKeyboardButton("âš¡ Medium Energy", callback_data='energy_medium')],
            [InlineKeyboardButton("ğŸª« Low Energy", callback_data='energy_low')]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await query.edit_message_text(
            "âš¡ **Energy Check**\n\nHow's your energy level right now?",
            parse_mode='Markdown',
            reply_markup=reply_markup
        )
        
    elif data.startswith('energy_'):
        level = data.split('_')[1]
        suggestions = {
            'high': "ğŸ”‹ **High Energy!** Perfect for:\nâ€¢ Deep work tasks\nâ€¢ Complex projects\nâ€¢ Important decisions\nâ€¢ Creative work",
            'medium': "âš¡ **Medium Energy!** Good for:\nâ€¢ Regular tasks\nâ€¢ Email and calls\nâ€¢ Planning\nâ€¢ Household tasks",
            'low': "ğŸª« **Low Energy** - Take it easy:\nâ€¢ Quick wins only\nâ€¢ Simple errands\nâ€¢ Routine tasks\nâ€¢ Or just rest!"
        }
        
        await query.edit_message_text(
            suggestions.get(level, "Energy logged!"),
            parse_mode='Markdown'
        )
        
    elif data.startswith('breakdown_'):
        await query.edit_message_text(
            "ğŸ”¨ **Breaking down task...**\n\n"
            "1. Start with the easiest part\n"
            "2. Set a 15-minute timer\n"
            "3. Do just one small step\n"
            "4. Take a 5-minute break\n"
            "5. Repeat if energy allows",
            parse_mode='Markdown'
        )
        
    elif data.startswith('notify_'):
        member = data.split('_')[1]
        await query.edit_message_text(
            f"ğŸ“± **Notification sent to {member.title()}!**\n\n"
            "(In production, this would send an actual message)",
            parse_mode='Markdown'
        )
        
    elif data.startswith('complete_'):
        await query.edit_message_text(
            "âœ… **Task marked complete!**\n\n"
            "Great job! Remember to celebrate small wins! ğŸ‰",
            parse_mode='Markdown'
        )
    
    elif data == 'today_tasks':
        user_id = query.from_user.id
        count = user_sessions.get(user_id, {}).get('tasks_today', 0)
        
        await query.edit_message_text(
            f"ğŸ“Š **Today's Progress**\n\n"
            f"Tasks captured: {count}\n"
            f"Energy level: Last checked {user_sessions.get(user_id, {}).get('last_energy_check', 'Never')}\n\n"
            f"Remember: Progress > Perfection! ğŸ’ª",
            parse_mode='Markdown'
        )

async def status(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Enhanced status check"""
    status_msg = "**ğŸ” System Status**\n\n"
    
    # Bot status
    status_msg += "ğŸŸ¢ **Bot:** Lyco v5 Online\n"
    
    # AI status
    if task_parser and task_parser.anthropic:
        status_msg += "ğŸŸ¢ **AI:** Claude Connected\n"
    else:
        status_msg += "ğŸ”´ **AI:** No API key\n"
    
    # Notion status check
    try:
        headers = {
            'Authorization': f'Bearer {NOTION_TOKEN}',
            'Notion-Version': NOTION_VERSION
        }
        async with aiohttp.ClientSession() as session:
            async with session.get(
                f'https://api.notion.com/v1/databases/{NOTION_DATABASE_ID}',
                headers=headers,
                timeout=5
            ) as resp:
                if resp.status == 200:
                    status_msg += "ğŸŸ¢ **Notion:** Connected\n"
                else:
                    status_msg += f"ğŸ”´ **Notion:** Error {resp.status}\n"
    except Exception as e:
        status_msg += f"ğŸ”´ **Notion:** {str(e)[:30]}\n"
    
    # Session stats
    total_users = len(user_sessions)
    total_tasks = sum(s.get('tasks_today', 0) for s in user_sessions.values())
    
    status_msg += f"\n**ğŸ“Š Session Stats**\n"
    status_msg += f"Active users: {total_users}\n"
    status_msg += f"Tasks today: {total_tasks}\n"
    
    status_msg += "\n**ğŸ”§ Configuration**\n"
    status_msg += f"Database: `...{NOTION_DATABASE_ID[-8:]}`\n"
    status_msg += f"Model: Claude 3 Haiku\n"
    status_msg += f"Parser: Enhanced v2"
    
    await update.message.reply_text(status_msg, parse_mode='Markdown')

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Help command with examples"""
    help_text = '''**ğŸ“š Lyco Help Guide**

**Basic Commands:**
/start - Initialize bot
/status - Check system status
/help - This guide

**Task Examples:**

**Simple tasks:**
â€¢ "Buy milk"
â€¢ "Call dentist"
â€¢ "Email report to team"

**Family delegation:**
â€¢ "Ask Viola to pick up kids"
â€¢ "Cindy handle insurance forms"
â€¢ "Persy clean room after school"

**Time-sensitive:**
â€¢ "Meeting tomorrow at 2pm"
â€¢ "Urgent: Fix server issue"
â€¢ "Review slides by Friday"

**Energy-aware:**
â€¢ "When I have energy: analyze data"
â€¢ "Quick task: reply to John"
â€¢ "Deep work: write proposal"

**Tips for ADHD:**
â€¢ Start with action verbs
â€¢ Be specific, not vague
â€¢ Include context/location
â€¢ Break big tasks into small ones
â€¢ Celebrate completing tasks!

**Need more help?** Just ask!'''
    
    await update.message.reply_text(help_text, parse_mode='Markdown')

def main():
    """Main bot entry point"""
    if not BOT_TOKEN:
        logger.error('No TELEGRAM_BOT_TOKEN found!')
        print("âŒ ERROR: Set TELEGRAM_BOT_TOKEN environment variable")
        return
    
    if not ANTHROPIC_API_KEY:
        logger.warning('No ANTHROPIC_API_KEY - running with limited features')
        print("âš ï¸  WARNING: Set ANTHROPIC_API_KEY for AI features")
    
    logger.info('Starting Lyco bot v5...')
    print("ğŸš€ Lyco Bot v5 Starting...")
    print(f"âœ… Notion Database: {NOTION_DATABASE_ID}")
    print(f"âœ… AI Parser: {'Enabled' if task_parser else 'Disabled'}")
    
    # Create application
    application = Application.builder().token(BOT_TOKEN).build()
    
    # Command handlers
    application.add_handler(CommandHandler('start', start))
    application.add_handler(CommandHandler('status', status))
    application.add_handler(CommandHandler('help', help_command))
    
    # Message handler for tasks
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    
    # Button callback handler
    application.add_handler(CallbackQueryHandler(button_callback))
    
    # Start bot
    print("âœ… Bot ready! Waiting for messages...")
    logger.info('Bot started successfully')
    
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == '__main__':
    main()
