#!/bin/sh

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "${YELLOW}ðŸ›¡ï¸  Security Check: Scanning staged files for secrets...${NC}"

# Define forbidden patterns
# Format: "Pattern Description|RegexPattern"
PATTERNS=(
    "Anthropic API Key|sk-ant-"
    "Notion Token|ntn_"
    "Private Key|-----BEGIN PRIVATE KEY-----"
    "GitHub Token|ghp_"
    "Slack Token|xox[baprs]-"
    "Google Client Secret|client_secret"
    "OpenAI Key|sk-[a-zA-Z0-9]{20}T3BlbkFJ[a-zA-Z0-9]{20}"
)

# Get list of staged files, excluding deletions and this script itself
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

if [ -z "$STAGED_FILES" ]; then
    echo "${GREEN}âœ… No files staged.${NC}"
    exit 0
fi

EXIT_CODE=0

for FILE in $STAGED_FILES; do
    # Skip detecting secrets in the hook script itself
    if [[ "$FILE" == ".husky/pre-commit" ]]; then
        continue
    fi

    # Skip check for specific allowed files if needed (e.g., lock files)
    if [[ "$FILE" == *"package-lock.json"* ]]; then
        continue
    fi

    # Check for large files (>10MB)
    FILE_SIZE=$(wc -c < "$FILE" | tr -d ' ')
    if [ "$FILE_SIZE" -gt 10485760 ]; then
         echo "${RED}âŒ Error: Large file detected ($((FILE_SIZE/1024/1024))MB): $FILE${NC}"
         echo "   Please remove this file or track it with Git LFS."
         EXIT_CODE=1
    fi

    # Check for secrets
    for PATTERN_DEF in "${PATTERNS[@]}"; do
        NAME="${PATTERN_DEF%%|*}"
        REGEX="${PATTERN_DEF#*|}"
        
        # Check if the file contains the pattern
        if grep -qE -e "$REGEX" "$FILE"; then
            echo "${RED}âŒ Error: Potential $NAME found in: $FILE${NC}"
            
            # Show the matching line number (masked output)
            grep -nE -e "$REGEX" "$FILE" | sed 's/^/   Line /'
            
            EXIT_CODE=1
        fi
    done
done

if [ $EXIT_CODE -ne 0 ]; then
    echo ""
    echo "${RED}ðŸš« Commit rejected due to security violations.${NC}"
    echo "   To ignore this warning (DANGEROUS), run: git commit --no-verify"
    exit 1
fi

echo "${GREEN}âœ… Security check passed.${NC}"
exit 0
